---
{{ if .Values.secretProviderClass.enabled }}
apiVersion: secrets-store.csi.x-k8s.io/v1alpha1
kind: SecretProviderClass
metadata:
  name: {{ .Values.secretProviderClass.name }}  # The name of the Azure Key Vault
  namespace: {{ .Values.namespace }}
spec:
  provider: azure
  secretObjects:
    {{- if .Values.certSecretName }}
    - secretName: {{ .Values.certSecretName }}
      data:
        - key: tls.key
          objectName: {{ .Values.secretProviderClass.secret }}
        - key: tls.crt
          objectName: {{ .Values.secretProviderClass.secret }}
    {{ end }}
    - secretName: {{ .Values.kvSecretName }}
      type: Opaque
      data:
        - key: PRIORITY-ADO-ACCESS-TOKEN
          objectName: PRIORITY-ADO-ACCESS-TOKEN
  parameters:
    useVMManagedIdentity: 'false'
    userAssignedIdentityID: 'false'
    usePodIdentity: 'false'
    clientID: {{ .Values.identity.clientID }}
    objects: |
      array:
        - |
          objectName: PRIORITY-ADO-ACCESS-TOKEN
          objectType: secret
    keyvaultName: {{ .Values.secretProviderClass.keyvaultName }}  # The name of the Azure Key Vault
    resourceGroup: {{ .Values.secretProviderClass.resourceGroupName }}  # The name of the Resource Group the KeyVault is in
    subscriptionId: {{ .Values.secretProviderClass.subscriptionId }}  # The subscription ID containing the Azure Key Vault instance
    tenantId: {{ .Values.secretProviderClass.tenantId }}  # The tenant ID containing the Azure Key Vault instance
{{- end -}}
